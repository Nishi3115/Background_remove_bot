# Background Removal Telegram Bot

## Описание проекта

Этот проект представляет собой Telegram-бота, который принимает изображение от пользователя, удаляет фон с помощью одной из двух моделей (по умолчанию `Rembg`, опционально `RMBG-2.0` от Bria AI), заменяет фон на выбранный пользователем и отправляет результат обратно. Бот реализован с использованием библиотеки `aiogram` для взаимодействия с Telegram API и различных инструментов компьютерного зрения для обработки изображений.  

Фото каждого пользователя хранятся в отдельных папках. Используются две основные модели, которые неплохо обрабатывают фон в общем случае. Идеальный обработчик фона невозможно сделать для всех фотографий, поэтому для каких-то частных случав работать будет некорректно. Чтобы улучшить качество нужно подгонять методы и используемые инструменты под конкретный тип фотографий и объетов на них.

### Основные функции бота:
1. **Приём изображения**: Пользователь отправляет фото в чат с ботом.
2. **Удаление фона**: Бот по умолчанию использует модель `Rembg` (основанную на U²-Net) для удаления фона. После первого результата пользователь может выбрать опцию "Переделать фото", чтобы попробовать модель `RMBG-2.0`.
3. **Замена фона**: Пользователь выбирает один из предопределённых фонов (лес, офис, пляж, город, космос, студия, горы).
4. **Отправка результата**: Бот отправляет обработанное изображение с новым фоном и предлагает кнопку "Переделать фото" для повторной обработки с другой моделью.

### Используемые технологии:
- **Язык программирования**: Python 3.10+.
- **Библиотеки**:
  - `aiogram` — для создания Telegram-бота.
  - `rembg` — для удаления фона (модель U²-Net).
  - `transformers` и `torch` — для работы с моделью `RMBG-2.0`.
  - `Pillow` — для обработки изображений.
- **Модели**:
  - `Rembg` (U²-Net) — по умолчанию.
  - `RMBG-2.0` (Bria AI) — опционально, используется при повторной обработке.

## Установка и запуск

### Требования
- Python 3.10 или выше.
- Доступ к интернету для загрузки моделей и зависимостей.
- Telegram-бот токен (получите его через [@BotFather](https://t.me/BotFather)).
- (Опционально) GPU с поддержкой CUDA для ускорения работы модели `RMBG-2.0`.

### Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/<ваш-username>/<ваш-репозиторий>.git
   cd <ваш-репозиторий>

2. **Создайте виртуальное окружение (рекомендуется)**:
    ```bash
   python -m venv venv
    source venv/bin/activate  # Для Linux/Mac
    venv\Scripts\activate     # Для Windows

3. **Установите зависимости**:
    Убедитесь, что у вас установлен pip, и выполните:
    ```bash
    pip install -r requirements.txt
Список зависимостей в requirements.txt:
* aiogram==3.10.0
* rembg==2.0.57
* torch==2.3.0
* torchvision==0.18.0
* transformers==4.43.3
* pillow==10.4.0
* kornia==0.7.3
* timm==1.0.8

Примечание: Если вы хотите использовать GPU для ускорения RMBG-2.0, установите PyTorch с поддержкой CUDA:

    pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118

(Замените cu118 на вашу версию CUDA, например, cu121.)

4. **Настройте токен бота**:  
Откройте файл bot.py и вставьте ваш Telegram-бот токен в переменную TOKEN:
    ```python
    TOKEN = "ваш_токен_бота"

4. **Подготовьте фоны**:  
Создайте папку templates в корневой директории проекта и поместите туда изображения фонов (в формате .jpeg или .png). Названия файлов должны соответствовать ключам в словаре
BACKGROUND_OPTIONS:
* forest.jpeg
* office.jpeg
* beach.jpeg
* city.jpeg
* space.jpeg
* studio.jpeg
* mountains.jpeg

Если какой-либо фон отсутствует, бот использует белый фон по умолчанию.

## Запуск

1. **Убедитесь, что виртуальное окружение активировано**: 
    ```bash
    source venv/bin/activate  # Для Linux/Mac
    venv\Scripts\activate     # Для Windows

2. **Запустите бота**:  
    ```bash
    python bot.py

3. **Откройте Telegram, найдите вашего бота (например, @YourBotName), отправьте команду /start и загрузите фото для обработки.**

## Использование
1. Запустите бота с помощью команды /start.
2. Отправьте боту любое изображение.
3. Выберите фон из предложенных вариантов (лес, офис, пляж и т.д.).
4. Бот удалит фон с помощью Rembg и заменит его на выбранный, затем отправит результат.
5. Нажмите кнопку "Переделать фото", чтобы повторить обработку с использованием модели RMBG-2.0.

Качество удаления фона и замены
* Rembg: Хорошо справляется с однотонными фонами (например, снег), но иногда оставляет артефакты на сложных изображениях.
* RMBG-2.0: Более точная сегментация в сложных случаях, но может ошибочно выделять некоторый фон как часть объекта. Для улучшения используется предобработка (увеличение яркости), чтобы сделать фон более "фоновым".
* Замена фона: Фон заменяется корректно, с сохранением пропорций и размеров изображения.

## Работа бота в реальном времени
* Бот работает стабильно, обрабатывая запросы в течение нескольких секунд (на CPU). Для ускорения рекомендуется использовать GPU, особенно для RMBG-2.0.
* Возможна задержка при использовании RMBG-2.0 на CPU из-за размера изображения (1024x1024). Для оптимизации можно уменьшить image_size до (512, 512).

